// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  phone    String?  @unique
  name     String?
  password String

  @@map("user")
}

model Document {
  id           String    @id @default(cuid())
  kind         String
  originalName String
  storageName  String
  mimeType     String
  sizeBytes    Int
  createdAt    DateTime  @default(now())
  contractId   String?   @unique
  contract     Contract? @relation(fields: [contractId], references: [id])

  @@map("document")
}

model Contract {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contractNumber String
  contractDate   String
  clientFullName String
  clientPhone    String?
  price          Int
  comment        String?

  deadmanAddress  String
  deadmanFullName String?
  deadmanAge      Int
  deadmanBirthday DateTime
  deadmanDeathDay DateTime

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  document Document?
  services ContractService[]
  products ContractProduct[]

  @@index([createdAt])
  @@map("contract")
}

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name      String
  phone     String
  contracts Contract[]

  @@unique([id])
  @@map("customer")
}

model Product {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name             String
  price            Int
  unit             String            @default("pcs")
  contractProducts ContractProduct[]

  @@map("product")
}

model ContractProduct {
  id           String  @id @default(cuid())
  contractId   String
  productId    String
  quantity     Int     @default(1)
  unitPrice    Int // цена на момент договора
  comment      String?
  nameSnapshot String

  contract Contract @relation(fields: [contractId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])

  @@unique([contractId, productId]) // если в договоре одна строка на товар
  @@index([contractId])
  @@map("contract_product")
}

model Service {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name             String
  defaultPrice     Int
  isActive         Boolean           @default(true)
  contractServices ContractService[]

  @@map("service")
}

// Снимок услуги, для удобства работы с контрактом
model ContractService {
  id                  String  @id @default(cuid())
  contractId          String
  serviceId           String
  price               Int
  comment             String?
  serviceNameSnapshot String

  contract Contract @relation(fields: [contractId], references: [id])
  service  Service  @relation(fields: [serviceId], references: [id])

  @@unique([contractId, serviceId])
  @@index([contractId])
  @@map("contract_service")
}
